<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BSO Projekt â€“ Symulator Kodowania Gold</title>
    <link rel="stylesheet" href="/static/style.css">
    <script src="https://unpkg.com/htmx.org@1.9.10" crossorigin="anonymous"></script>
</head>
<body>
    <div class="main-title">BSO Projekt - Symulator Kodowania Gold</div>
    <div class="subtitle">Konfiguracja ModuÅ‚Ã³w</div>
    
    <form id="sim-form" 
          hx-post="/simulate" 
          hx-target="#simulation-status"
          hx-swap="innerHTML">
        <div class="modules-grid">
            <div class="card">
                <div class="card-header"><span class="icon">ðŸ“‹</span>Dane WejÅ›ciowe</div>
                <div class="card-config">
                    <label>Tekst do zakodowania:
                        <input type="text" name="seqText" placeholder="np. hello world">
                    </label>
                    <label>DÅ‚ugoÅ›Ä‡ losowej sekwencji:
                        <input type="number" name="seqLength" value="64" min="1" max="256">
                    </label>
                </div>
                <div class="card-result" id="result-generator">(wynik pojawi siÄ™ po uruchomieniu)</div>
            </div>
            <div class="card">
                <div class="card-header"><span class="icon">ðŸ”‘</span>Konfiguracja Kodu Gold</div>
                <div class="card-config">
                    <label>DÅ‚ugoÅ›Ä‡ rejestru (n):
                        <input type="number" name="goldN" value="10" min="2" max="16">
                    </label>                    <label>LFSR1 Taps (przecinek):
                        <input type="text" name="goldTaps1" value="0,3">
                    </label>
                    <label>LFSR2 Taps (przecinek):
                        <input type="text" name="goldTaps2" value="0,2,3,8">
                    </label>
                </div>
                <div class="card-result" id="result-encoder">(wynik pojawi siÄ™ po uruchomieniu)</div>
            </div>
            <div class="card">
                <div class="card-header">
                    <input type="checkbox" name="errorEnabled" checked> <span class="icon">âš¡</span>Dodawanie BÅ‚Ä™dÃ³w
                </div>
                <div class="card-config">
                    <label>Typ bÅ‚Ä™du:
                        <select name="errorType">
                            <option value="random">Losowy</option>
                            <option value="burst">Seria (burst)</option>
                        </select>
                    </label>
                    <label>PrawdopodobieÅ„stwo [%]:
                        <input type="number" name="errorRate" value="5" min="0" max="100">
                    </label>
                </div>
                <div class="card-result" id="result-error">(wynik pojawi siÄ™ po uruchomieniu)</div>
            </div>
            <div class="card">
                <div class="card-header">
                    <input type="checkbox" name="decoderEnabled" checked> 
                    <span class="icon">ðŸ”’</span>Dekoder
                </div>
                <div class="card-config">
                    <label>Typ dekodera:
                        <select name="decoderType">
                            <option value="xor">Prosty XOR</option>
                        </select>
                    </label>
                </div>
                <div class="card-result" id="result-decoder">(wynik pojawi siÄ™ po uruchomieniu)</div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <input type="checkbox" name="berEnabled" checked> 
                    <span class="icon">ðŸ“Š</span>Analiza BER
                </div>
                <div class="card-config">
                    <span>PorÃ³wnanie oryginaÅ‚u i wyjÅ›cia dekodera</span>
                </div>
                <div class="card-result" id="result-ber">(wynik pojawi siÄ™ po uruchomieniu)</div>
            </div>
        </div>
        <div class="actions">
            <button type="submit" class="btn-main">Uruchom SymulacjÄ™</button>
            <button type="reset" class="btn-reset">Reset Konfiguracji</button>
        </div>
    </form>
    
    <div id="simulation-status"></div>
    
    <script>
    // Add event listeners for HTMX events
    document.addEventListener('htmx:beforeRequest', function(evt) {
        if (evt.detail.elt.id === 'sim-form') {
            console.log('Starting simulation...');
            document.getElementById('result-generator').innerHTML = 'Generowanie...';
            document.getElementById('result-encoder').innerHTML = 'Kodowanie...';
            document.getElementById('result-error').innerHTML = 'Dodawanie bÅ‚Ä™dÃ³w...';
            document.getElementById('result-decoder').innerHTML = 'Dekodowanie...';
            document.getElementById('result-ber').innerHTML = 'Analiza BER...';
            
            const btn = document.querySelector('button[type="submit"]');
            btn.disabled = true;
            btn.textContent = 'Trwa symulacja...';
        }
    });
    
    document.addEventListener('htmx:afterRequest', function(evt) {
        if (evt.detail.elt.id === 'sim-form') {
            console.log('Simulation completed, loading module results...');
            const btn = document.querySelector('button[type="submit"]');
            btn.disabled = false;
            btn.textContent = 'Uruchom SymulacjÄ™';
            
            // Check if simulation was successful (status 200)
            if (evt.detail.xhr.status === 200) {
                // Add a small delay to ensure the backend has finished storing results
                setTimeout(loadModuleResults, 100);
            } else {
                console.error('Simulation failed with status:', evt.detail.xhr.status);
            }
        }
    });
    
    async function loadModuleResults() {
        console.log('Loading module results...');
        
        try {
            // 1. Generator - always load
            const generatorResponse = await fetch('/generator');
            if (generatorResponse.ok) {
                const generatorHtml = await generatorResponse.text();
                document.getElementById('result-generator').innerHTML = generatorHtml;
                console.log('Generator result loaded');
            } else {
                console.error('Generator request failed:', generatorResponse.status);
                document.getElementById('result-generator').innerHTML = '<div class="error">BÅ‚Ä…d Å‚adowania generatora</div>';
            }
            
            // 2. Encoder - always load
            const encoderResponse = await fetch('/encoder');
            if (encoderResponse.ok) {
                const encoderHtml = await encoderResponse.text();
                document.getElementById('result-encoder').innerHTML = encoderHtml;
                console.log('Encoder result loaded');
            } else {
                console.error('Encoder request failed:', encoderResponse.status);
                document.getElementById('result-encoder').innerHTML = '<div class="error">BÅ‚Ä…d Å‚adowania kodera</div>';
            }
            
            // 3. Error module
            const errorEnabled = document.querySelector('input[name="errorEnabled"]').checked;
            console.log('Error enabled:', errorEnabled);
            if (errorEnabled) {
                const errorResponse = await fetch('/error');
                if (errorResponse.ok) {
                    const errorHtml = await errorResponse.text();
                    document.getElementById('result-error').innerHTML = errorHtml;
                    console.log('Error result loaded');
                } else {
                    console.error('Error request failed:', errorResponse.status);
                    document.getElementById('result-error').innerHTML = '<div class="error">BÅ‚Ä…d Å‚adowania moduÅ‚u bÅ‚Ä™dÃ³w</div>';
                }
            } else {
                document.getElementById('result-error').innerHTML = '<div class="result-item">ModuÅ‚ wyÅ‚Ä…czony</div>';
            }
            
            // 4. Decoder module
            const decoderEnabled = document.querySelector('input[name="decoderEnabled"]').checked;
            console.log('Decoder enabled:', decoderEnabled);
            if (decoderEnabled) {
                const decoderResponse = await fetch('/decoder');
                if (decoderResponse.ok) {
                    const decoderHtml = await decoderResponse.text();
                    document.getElementById('result-decoder').innerHTML = decoderHtml;
                    console.log('Decoder result loaded');
                } else {
                    console.error('Decoder request failed:', decoderResponse.status);
                    document.getElementById('result-decoder').innerHTML = '<div class="error">BÅ‚Ä…d Å‚adowania dekodera</div>';
                }
            } else {
                document.getElementById('result-decoder').innerHTML = '<div class="result-item">ModuÅ‚ wyÅ‚Ä…czony</div>';
            }
            
            // 5. BER module
            const berEnabled = document.querySelector('input[name="berEnabled"]').checked;
            console.log('BER enabled:', berEnabled);
            if (berEnabled) {
                const berResponse = await fetch('/ber');
                if (berResponse.ok) {
                    const berHtml = await berResponse.text();
                    document.getElementById('result-ber').innerHTML = berHtml;
                    console.log('BER result loaded');
                } else {
                    console.error('BER request failed:', berResponse.status);
                    document.getElementById('result-ber').innerHTML = '<div class="error">BÅ‚Ä…d Å‚adowania analizy BER</div>';
                }
            } else {
                document.getElementById('result-ber').innerHTML = '<div class="result-item">ModuÅ‚ wyÅ‚Ä…czony</div>';
            }
            
        } catch (error) {
            console.error('Error loading module results:', error);
        }
    }
    </script>
    
    <div id="results"></div>
</body>
</html>
